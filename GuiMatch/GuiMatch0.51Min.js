var newGameLoad=0;window.onload=function(){var canvas=document.getElementById("viewport1");var context=canvas.getContext("2d");var soundLoop=document.getElementById("gameSoundLoop");soundLoop.volume=0.3;var lastframe=0;var fpstime=0;var framecount=0;var fps=0;var levelUpScore=2000;var matchCount=0;var levelCount=1;var levelBump=0;var levelBump2=0;var levelRating=0;var previousScore=0;var levelScoreProgress=0;var shuffleTiles=false;var playOnce=0;var addSpecialHoriz=false;var addSpecialVert=false;var starCash=0;var totalSeconds=0;if(typeof localStorage["starCash"]==="undefined"){localStorage["starCash"]=0;starCash=0;};starCash=parseInt(localStorage["starCash"]);var drag=false;var level={x:12,y:87,columns:7,rows:7,tilewidth:50,tileheight:50,tiles:[],tileImage:[],selectedtile:{selected:false,column:0,row:0}};var tilecolors=[[255,128,128,0],[128,255,128,1],[128,128,255,2],[255,255,128,3],[255,128,255,4],[128,255,255,5],[255,255,255,6]];var clusters=[];var moves=[];var currentmove={column1:0,row1:0,column2:0,row2:0};var gemcolors=7;var gamestates={init:0,ready:1,resolve:2,levelUp:3,almostOver:4};var gamestate=gamestates.init;var score=0;var animationstate=0;var animationtime=0;var animationtimetotal=0.1;var showmoves=false;var aibot=false;var gameover=false;var imgArray=new Array();imgArray[0]=new Image();imgArray[0].src='Images/0.png';imgArray[1]=new Image();imgArray[1].src='Images/1.png';imgArray[2]=new Image();imgArray[2].src='Images/2.png';imgArray[3]=new Image();imgArray[3].src='Images/3.png';imgArray[4]=new Image();imgArray[4].src='Images/4.png';imgArray[5]=new Image();imgArray[5].src='Images/5.png';imgArray[6]=new Image();imgArray[6].src='Images/6.png';imgArray[7]=new Image();imgArray[7].src='Images/7.png';imgArray[8]=new Image();imgArray[8].src='Images/8.png';imgArray[9]=new Image();imgArray[9].src='Images/9.png';var imgArray2=new Array();imgArray2[0]=new Image();imgArray2[0].src='Images/footerImg.png';imgArray2[1]=new Image();imgArray2[1].src='Images/levelUp.png';imgArray2[2]=new Image();imgArray2[2].src='Images/starCashBack.png';imgArray2[3]=new Image();imgArray2[3].src='Images/bigButton.png';imgArray2[4]=new Image();imgArray2[4].src='Images/star.png';imgArray2[5]=new Image();imgArray2[5].src='Images/3rdStar.png';imgArray2[6]=new Image();imgArray2[6].src='Images/hudLevel.png';imgArray2[7]=new Image();imgArray2[7].src='Images/HUD/gameOver2.png';imgArray2[8]=new Image();imgArray2[8].src='Images/HUD/newGame.png';imgArray2[9]=new Image();imgArray2[9].src='Images/HUD/buyNow.png';imgArray2[10]=new Image();imgArray2[10].src='Images/HUD/levelBonus.png';imgArray2[11]=new Image();imgArray2[11].src='Images/HUD/awesome2.gif';setInterval(setTime,1000);function setTime(){if(newGameLoad==1){totalSeconds=0;newGameLoad=0;}++totalSeconds;context.fillStyle="#ffff00";context.font="22px Comic Sans MS";}function pad(val){var valString=val+"";if(valString.length<2){return"0"+valString;}else{return valString;}}var swapSound=new Howl({src:['Sounds/gametinywarp.mp3'],volume:0.5,preload:true,});swapSound.play();var levelUpSound=new Howl({src:['Sounds/levelup.mp3'],volume:0.9,preload:true,});levelUpSound.play();var gameOverSound=new Howl({src:['Sounds/shortOver.mp3'],volume:0.9,preload:true,});gameOverSound.play();var buttons=[{x:15,y:475,width:100,height:30,text:"New Game"},{x:135,y:475,width:100,height:30,text:"Hint"},{x:255,y:475,width:100,height:30,text:"Auto"}];function init(){canvas.addEventListener("mousemove",onMouseMove);canvas.addEventListener("mousedown",onMouseDown);canvas.addEventListener("mouseup",onMouseUp);canvas.addEventListener("mouseout",onMouseOut);for(var i=0;i<level.columns;i++){level.tiles[i]=[];for(var j=0;j<level.rows;j++){level.tiles[i][j]={type:0,shift:0}}}newGame();totalSeconds=0;main(0);}function main(tframe){window.requestAnimationFrame(main);update(tframe);render();}function update(tframe){var dt=(tframe-lastframe)/1000;lastframe=tframe;updateFps(dt);if(gamestate==gamestates.ready){if(moves.length<=0){gameover=true;if(playOnce>=2){playOnce++;}else{playOnce=1;}if(shuffleTiles){shuffle();}function shuffle(){createLevel();var rowcount1=level.rows;var colCount1=level.columns;for(var r=0;r<rowcount1;r++){for(var c=0;c<colCount1;c++){matchlength=3;clusters.push({column:r,row:c+1-matchlength,length:matchlength,horizontal:false});}}shuffleTiles=false;findMoves();gamestate=gamestates.resolve;animationstate=0;animationtime=0;}}if(aibot){animationtime+=dt;if(animationtime>animationtimetotal){findMoves();if(moves.length>0){var move=moves[Math.floor(Math.random()*moves.length)];mouseSwap(move.column1,move.row1,move.column2,move.row2);}else{aibot=false;}animationtime=0;}}}else if(gamestate==gamestates.resolve){animationtime+=dt;if(animationstate==0){if(animationtime>animationtimetotal){findClusters();if(clusters.length>0){swapSound.stop();swapSound.play();for(var i=0;i<clusters.length;i++){score+=100*(clusters[i].length-2);;levelScoreProgress=levelScoreProgress+(100*(clusters[i].length-2));context.fillStyle="#ffff00";context.font="22px Comic Sans MS";drawCenterText("Score",230,level.y-75,175);context.font="26px Comic Sans MS";drawCenterText(score,230,level.y-50,175);matchCount=matchCount+(clusters[i].length-2);progressBar(levelScoreProgress,levelCount);}removeClusters();animationstate=1;}else{gamestate=gamestates.ready;}animationtime=0;}}else if(animationstate==1){if(animationtime>animationtimetotal){shiftTiles();animationstate=0;animationtime=0;findClusters();if(clusters.length<=0){gamestate=gamestates.ready;}}}else if(animationstate==2){if(animationtime>animationtimetotal){swap(currentmove.column1,currentmove.row1,currentmove.column2,currentmove.row2);findClusters();if(clusters.length>0){animationstate=0;animationtime=0;gamestate=gamestates.resolve;}else{animationstate=3;animationtime=0;}findMoves();findClusters();}}else if(animationstate==3){if(animationtime>animationtimetotal){swap(currentmove.column1,currentmove.row1,currentmove.column2,currentmove.row2);gamestate=gamestates.ready;}}findMoves();findClusters();}}function updateFps(dt){if(fpstime>0.25){fps=Math.round(framecount/fpstime);fpstime=0;framecount=0;}fpstime+=dt;framecount++;}function drawCenterText(text,x,y,width){var textdim=context.measureText(text);context.fillText(text,x+(width-textdim.width)/2,y);}function render(){drawFrame();context.fillStyle="#ffff00";context.font="16px Comic Sans MS";drawCenterText("Score",230,level.y-70,175);context.font="22px Comic Sans MS";drawCenterText(score,230,level.y-50,175);drawButtons();var levelwidth=level.columns*level.tilewidth;var levelheight=level.rows*level.tileheight;context.fillStyle="#000000";context.fillRect(level.x-4,level.y-4,levelwidth+8,levelheight+8);renderTiles();renderClusters();if(showmoves&&clusters.length<=0&&gamestate==gamestates.ready){renderMoves();}if(gameover){if(playOnce==1){gameSoundLoop.pause();gameOverSound.play();playOnce++;}context.fillStyle="rgba(0, 0, 0, 0.8)";context.fillRect(level.x,level.y,levelwidth,levelheight);context.drawImage(imgArray2[7],0,65);document.getElementById("progressBar").style.display='none';context.drawImage(imgArray2[8],60,545);context.drawImage(imgArray2[9],190,545);context.fillStyle="#cc00cc";context.font="20px Comic Sans MS";context.fillText(starCash,175,504);gamestate=gamestates.almostOver;}if(gamestate==gamestates.levelUp){context.fillStyle="rgba(255, 0, 255, 0.9)";context.fillRect(level.x-10,level.y-10,levelwidth+30,levelheight+210);var elem=document.getElementById("myBar");elem.style.width='1%';context.drawImage(imgArray2[1],37,50);context.drawImage(imgArray2[10],115,375);context.drawImage(imgArray2[2],117,432);context.drawImage(imgArray2[3],112,512);context.drawImage(imgArray2[4],87,296);if(levelRating>=4){context.drawImage(imgArray2[4],217,296);}if(levelRating>=5){context.drawImage(imgArray2[5],147,262);}if(levelBump>=1){levelBump2=1;}context.font="30px Comic Sans MS";context.fillStyle="#cc00cc";drawCenterText(" +"+levelRating,180,412,50);drawCenterText(starCash,180,469,50);context.font="22px Comic Sans MS";drawCenterText("Next Level",level.x+2,level.y+levelheight+120,levelwidth);if(levelBump==1){levelCount++;levelBump=0;levelUpScore=(levelCount*1000);levelRating=3;if(totalSeconds<=30){levelRating=5;context.drawImage(imgArray2[4],217,296);context.drawImage(imgArray2[5],147,262);}else if(totalSeconds<=60){levelRating=4;context.drawImage(imgArray2[4],217,296);}else if(totalSeconds>=61){levelRating=3;}starCash=starCash+levelRating;localStorage["starCash"]=starCash;context.font="30px Comic Sans MS";context.fillStyle="#cc00cc";drawCenterText(" +"+levelRating,180,412,50);}document.getElementById("progressBar").style.display='none';}}function drawFrame(){context.fillStyle="#d0d0d0";context.fillRect(0,0,canvas.width,canvas.height);context.fillStyle="#33ccff";context.fillRect(1,1,canvas.width-2,canvas.height-2);context.fillStyle="#cc00cc";context.fillRect(0,0,canvas.width,65);context.fillStyle="#ffffff";context.font="24px Comic Sans MS";context.fillText("Gui Match",5,20);context.drawImage(imgArray2[6],50,22)
context.fillStyle="#000000";context.font="16px Comic Sans MS";context.fillText("Level: "+levelCount,160,55);context.fillStyle="#ffffff";context.font="14px Comic Sans MS";context.fillText("$"+starCash,325,62);context.fillStyle="#ffffff";context.font="14px Comic Sans MS";if(newGameLoad==1){totalSeconds=0;}context.fillText("Time:"+totalSeconds,2,62);}function drawButtons(){for(var i=0;i<buttons.length;i++){context.fillStyle="#cc00cc";context.fillRect(buttons[i].x,buttons[i].y,buttons[i].width,buttons[i].height);context.fillStyle="#ffffff";context.font="16px Comic Sans MS";var textdim=context.measureText(buttons[i].text);context.fillText(buttons[i].text,buttons[i].x+(buttons[i].width-textdim.width)/2,buttons[i].y+20);context.drawImage(imgArray2[0],10,490);}}function renderTiles(){for(var i=0;i<level.columns;i++){for(var j=0;j<level.rows;j++){var shift=level.tiles[i][j].shift;var coord=getTileCoordinate(i,j,0,(animationtime/animationtimetotal)*shift);if(level.tiles[i][j].type>=0){var col=tilecolors[level.tiles[i][j].type];var q=tilecolors[level.tiles[i][j]]
drawTile(coord.tilex,coord.tiley,col[0],col[1],col[2],col[3]);}if(level.selectedtile.selected){if(level.selectedtile.column==i&&level.selectedtile.row==j){drawTile(coord.tilex-3,coord.tiley-3,255,0,0,7);}}}}if(gamestate==gamestates.resolve&&(animationstate==2||animationstate==3)){var shiftx=currentmove.column2-currentmove.column1;var shifty=currentmove.row2-currentmove.row1;var coord1=getTileCoordinate(currentmove.column1,currentmove.row1,0,0);var coord1shift=getTileCoordinate(currentmove.column1,currentmove.row1,(animationtime/animationtimetotal)*shiftx,(animationtime/animationtimetotal)*shifty);var col1=tilecolors[level.tiles[currentmove.column1][currentmove.row1].type];var col1Image=[level.tiles[currentmove.column1][currentmove.row1].type];var coord2=getTileCoordinate(currentmove.column2,currentmove.row2,0,0);var coord2shift=getTileCoordinate(currentmove.column2,currentmove.row2,(animationtime/animationtimetotal)*-shiftx,(animationtime/animationtimetotal)*-shifty);var col2=tilecolors[level.tiles[currentmove.column2][currentmove.row2].type];var col2Image=[level.tiles[currentmove.column1][currentmove.row1].type];drawTile(coord1.tilex,coord1.tiley,0,0,0,8);drawTile(coord2.tilex,coord2.tiley,0,0,0,8);if(animationstate==2){drawTile(coord1shift.tilex,coord1shift.tiley,col1[0],col1[1],col1[2],col1[3]);drawTile(coord2shift.tilex,coord2shift.tiley,col2[0],col2[1],col2[2],col2[3]);}else{drawTile(coord2shift.tilex,coord2shift.tiley,col2[0],col2[1],col2[2],col1[3]);drawTile(coord1shift.tilex,coord1shift.tiley,col1[0],col1[1],col1[2],col2[3]);}}}function getTileCoordinate(column,row,columnoffset,rowoffset){var tilex=level.x+(column+columnoffset)*level.tilewidth;var tiley=level.y+(row+rowoffset)*level.tileheight;return{tilex:tilex,tiley:tiley};}function drawTile(x,y,r,g,b,i){context.drawImage(imgArray[i],x+1,y+1);}function renderClusters(){for(var i=0;i<clusters.length;i++){var coord=getTileCoordinate(clusters[i].column,clusters[i].row,0,0);if(clusters[i].horizontal){context.fillStyle="#00ff00";context.fillRect(coord.tilex+level.tilewidth/2,coord.tiley+level.tileheight/2-2,(clusters[i].length-1)*level.tilewidth,4);}else{context.fillStyle="#0000ff";context.fillRect(coord.tilex+level.tilewidth/2-2,coord.tiley+level.tileheight/2,4,(clusters[i].length-1)*level.tileheight);}}}function renderMoves(){for(var i=0;i<moves.length;i++){var coord1=getTileCoordinate(moves[i].column1,moves[i].row1,0,0);var coord2=getTileCoordinate(moves[i].column2,moves[i].row2,0,0);context.strokeStyle="#ebf442";context.lineWidth=4;context.beginPath();context.moveTo(coord1.tilex+level.tilewidth/2,coord1.tiley+level.tileheight/2);context.lineTo(coord2.tilex+level.tilewidth/2,coord2.tiley+level.tileheight/2);context.stroke();}}function newGame(i){if(i<1){score=0;levelUpScore=2000;levelScoreProgress=0;levelCount=1;playOnce=0;totalSeconds=0;levelScoreProgress=1;progressBar(1,1)
for(var q=0;q<=6;q++){var newsource=imgArray[q].src;newsource="Images/"+q+".png";imgArray[q].src=newsource;}}levelUpSound.stop();gameOverSound.stop();gameSoundLoop.pause();gameSoundLoop.play();progressBar(1,levelCount);document.getElementById("progressBar").style.display='block';gamestate=gamestates.ready;gameover=false;createLevel();findMoves();findClusters();}function createLevel(){var done=false;while(!done){for(var i=0;i<level.columns;i++){for(var j=0;j<level.rows;j++){level.tiles[i][j].type=getRandomTile();}}resolveClusters();findMoves();if(moves.length>0){done=true;gameOver=false;}}}function getRandomTile(){return Math.floor(Math.random()*tilecolors.length);}function resolveClusters(){findClusters();if(clusters.length>1){context.drawImage(imgArray2[11],50,65);}while(clusters.length>0){console.log(" cluster length = "+clusters.length);removeClusters();shiftTiles();findClusters();}}function findClusters(){clusters=[]
for(var j=0;j<level.rows;j++){var matchlength=1;for(var i=0;i<level.columns;i++){var checkcluster=false;if(i==level.columns-1){checkcluster=true;}else{if(level.tiles[i][j].type==level.tiles[i+1][j].type&&level.tiles[i][j].type!=-1){matchlength+=1;}else{checkcluster=true;}}if(checkcluster){if(matchlength>=3){clusters.push({column:i+1-matchlength,row:j,length:matchlength,horizontal:true});}if(matchlength>=4){addSpecialHoriz=true;}matchlength=1;}}}for(var i=0;i<level.columns;i++){var matchlength=1;for(var j=0;j<level.rows;j++){var checkcluster=false;if(j==level.rows-1){checkcluster=true;}else{if(level.tiles[i][j].type==level.tiles[i][j+1].type&&level.tiles[i][j].type!=-1){matchlength+=1;}else{checkcluster=true;}}if(checkcluster){if(matchlength>=3){clusters.push({column:i,row:j+1-matchlength,length:matchlength,horizontal:false});}if(matchlength>=5){addSpecialVert=true;}matchlength=1;}}}}function findMoves(){moves=[]
for(var j=0;j<level.rows;j++){for(var i=0;i<level.columns-1;i++){swap(i,j,i+1,j);findClusters();swap(i,j,i+1,j);if(clusters.length>0){moves.push({column1:i,row1:j,column2:i+1,row2:j});}}}for(var i=0;i<level.columns;i++){for(var j=0;j<level.rows-1;j++){swap(i,j,i,j+1);findClusters();swap(i,j,i,j+1);if(clusters.length>0){moves.push({column1:i,row1:j,column2:i,row2:j+1});}}}clusters=[]}function loopClusters(func){for(var i=0;i<clusters.length;i++){var cluster=clusters[i];var coffset=0;var roffset=0;for(var j=0;j<cluster.length;j++){func(i,cluster.column+coffset,cluster.row+roffset,cluster);if(cluster.horizontal){coffset++;}else{roffset++;}}}}function removeClusters(){loopClusters(function(index,column,row,cluster){level.tiles[column][row].type=-1;});for(var i=0;i<level.columns;i++){var shift=0;for(var j=level.rows-1;j>=0;j--){if(level.tiles[i][j].type==-1){shift++;level.tiles[i][j].shift=0;}else{level.tiles[i][j].shift=shift;}}}}function shiftTiles(){for(var i=0;i<level.columns;i++){for(var j=level.rows-1;j>=0;j--){if(level.tiles[i][j].type==-1){level.tiles[i][j].type=getRandomTile();}else{var shift=level.tiles[i][j].shift;if(shift>0){swap(i,j,i,j+shift)}}level.tiles[i][j].shift=0;}}}function getMouseTile(pos){var tx=Math.floor((pos.x-level.x)/level.tilewidth);var ty=Math.floor((pos.y-level.y)/level.tileheight);if(tx>=0&&tx<level.columns&&ty>=0&&ty<level.rows){return{valid:true,x:tx,y:ty};}return{valid:false,x:0,y:0};}function canSwap(x1,y1,x2,y2){if((Math.abs(x1-x2)==1&&y1==y2)||(Math.abs(y1-y2)==1&&x1==x2)){return true;}return false;}function swap(x1,y1,x2,y2){var typeswap=level.tiles[x1][y1].type;level.tiles[x1][y1].type=level.tiles[x2][y2].type;level.tiles[x2][y2].type=typeswap;}function mouseSwap(c1,r1,c2,r2){currentmove={column1:c1,row1:r1,column2:c2,row2:r2};level.selectedtile.selected=false;animationstate=2;animationtime=0;gamestate=gamestates.resolve;}function onMouseMove(e){var pos=getMousePos(canvas,e);if(drag&&level.selectedtile.selected){mt=getMouseTile(pos);if(mt.valid){if(canSwap(mt.x,mt.y,level.selectedtile.column,level.selectedtile.row)){mouseSwap(mt.x,mt.y,level.selectedtile.column,level.selectedtile.row);}}}}function onMouseDown(e){var pos=getMousePos(canvas,e);if(!drag){mt=getMouseTile(pos);if(mt.valid){var swapped=false;if(level.selectedtile.selected){if(mt.x==level.selectedtile.column&&mt.y==level.selectedtile.row){level.selectedtile.selected=false;drag=true;return;}else if(canSwap(mt.x,mt.y,level.selectedtile.column,level.selectedtile.row)){mouseSwap(mt.x,mt.y,level.selectedtile.column,level.selectedtile.row);swapped=true;}}if(!swapped){level.selectedtile.column=mt.x;level.selectedtile.row=mt.y;level.selectedtile.selected=true;}}else{level.selectedtile.selected=false;}drag=true;}for(var i=0;i<buttons.length;i++){if(pos.x>=buttons[i].x&&pos.x<buttons[i].x+buttons[i].width&&pos.y>=buttons[i].y&&pos.y<buttons[i].y+buttons[i].height){if(i==0){newGame(0);totalSeconds=0;}else if(i==1){showmoves=!showmoves;buttons[i].text=(showmoves?"Hide":"Show")+" Moves";}else if(i==2){aibot=!aibot;buttons[i].text="Auto "+(aibot?"On":"Off");}}}if(gamestate==gamestates.levelUp){newGame(1);progressBar(1,levelCount);levelScoreProgress=0;totalSeconds=0;}if(gamestate==gamestates.almostOver){if(pos.x>=50&&pos.x<170&&pos.y>=545&&pos.y<591){newGame(0);gamestate=gamestates.ready;gameOver=false;playOnce=0;totalSeconds=0;}if(pos.x>=185&&pos.x<310&&pos.y>=545&&pos.y<591){var currentcash=localStorage["starCash"];if(currentcash>=15){starCash=starCash-15;localStorage["starCash"]=starCash;newGame(2);shuffleTiles=true;gameover=false;playOnce=0;}else{return;}}}}function onMouseUp(e){drag=false;}function onMouseOut(e){drag=false;}function getMousePos(canvas,e){var rect=canvas.getBoundingClientRect();return{x:Math.round((e.clientX-rect.left)/(rect.right-rect.left)*canvas.width),y:Math.round((e.clientY-rect.top)/(rect.bottom-rect.top)*canvas.height)};}function progressBar(i,levelCount){var elem=document.getElementById("myBar");var currentWidth=percentwidth(elem);var width=currentWidth;var increase=((i/levelUpScore)*100);if(increase<1){increase=1}var id=setInterval(frame,10);function frame(){var currentWidth2=percentwidth(elem);if(currentWidth2<=increase){width++;elem.style.width=width+'%';currentWidth=elem.style.width;}else{clearInterval(id);}}if(increase>=100){levelUp()}}function percentwidth(elem){var pa=elem.offsetParent||elem;return((elem.offsetWidth/pa.offsetWidth)*100).toFixed(2);}function levelUp(){gamestate=gamestates.levelUp;soundLoop.pause();gameSoundLoop.pause();levelUpSound.play();levelBump=1;var levelAdjust=levelCount+1;if(parseInt(levelAdjust)>=2&&levelAdjust<=9){for(var q=0;q<=6;q++){var newsource=imgArray[q].src;newsource="Images/"+levelAdjust+q+".png";imgArray[q].src=newsource;}}if(parseInt(levelAdjust)>=11&&levelAdjust<=20){levelAdjust=levelAdjust-10;for(var q=0;q<=6;q++){var newsource=imgArray[q].src;newsource="Images/"+levelAdjust+q+".png";imgArray[q].src=newsource;}}if(parseInt(levelAdjust)>=21&&levelAdjust<=30){levelAdjust=levelAdjust-20;for(var q=0;q<=6;q++){var newsource=imgArray[q].src;newsource="Images/"+levelAdjust+q+".png";imgArray[q].src=newsource;}}if(parseInt(levelAdjust)>=31&&levelAdjust<=40){levelAdjust=levelAdjust-30;for(var q=0;q<=6;q++){var newsource=imgArray[q].src;newsource="Images/"+levelAdjust+q+".png";imgArray[q].src=newsource;}}if(parseInt(levelAdjust)>=41&&levelAdjust<=50){levelAdjust=levelAdjust-40;for(var q=0;q<=6;q++){var newsource=imgArray[q].src;newsource="Images/"+levelAdjust+q+".png";imgArray[q].src=newsource;}}}init();};function hideIntro(){var cover=document.getElementById("landingCover");cover.style.display='none';newGameLoad=1;newGame(0);}